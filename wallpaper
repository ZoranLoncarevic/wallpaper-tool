#!/bin/bash
# Copyright (C) 2018 Zoran Loncarevic

arg0=${0##*/}
cache_type=2
DEFAULT_WALLPAPER="${DEFAULT_WALLPAPER:-/usr/share/backgrounds/Green_by_Alan_Mattila.jpg}"
CACHE_DIR=~/.wallpaper/cache

declare -a the_recipe=()

usage() {
	cat >&2 << EOF_USAGE
usage: wallpaper command ...

Commands:
  set         -- set new wallpaper
  dim         -- dim...
  blur        -- blur...
  tint        -- tint current wallpaper
  next        -- change to next wallpaper
  prev        -- change to preious wallpaper
  browse      -- browse wallpapers
  getfilename -- print current wallpaper filename
EOF_USAGE
}

report_error() {
	echo "$arg0: $2" >&2
	exit $1
}

debug_log() {
	echo "$@" >&2
}

images_from_directory()
{
	(cd "$1"; ls $LS_FLAGS *.png *.jpg *.recipe) 2>/dev/null
}

first_file_from_dir()
{
	images_from_directory "$1" | head -n 1
}

last_file_from_dir()
{
	images_from_directory "$1" | tail -n 1
}

IS_CACHE1()
{
	[[ "$1" =~ .*/\.wall-cache/[^/]*__[^/]*$ ]]
}

IS_CACHE2()
{
	[[ "$1" =~ ^${CACHE_DIR/#\~/$HOME}/images/* ]]
}

get_current_wallpaper_filename()
{
	echo "$(gconftool --get /desktop/gnome/background/picture_filename)"
}

set_current_wallpaper()
{
	[[ ! $dry_run == yes ]] &&
	gconftool -t str --set /desktop/gnome/background/picture_filename "$1"
}

extract_arg() {
	case $1 in
		(*:*) echo ${1#*:} ;;
		(*)   echo ;;
	esac
}

cache2_to_cache1()
{
	local cache2=${1:-$(</dev/stdin)}
	if [[ $cache_type == 2 ]] && IS_CACHE2 "$cache2"; then
		cache2=($(head "$CACHE_DIR/refs/${cache2##*/}")) ||
			report_error 7 "Internal cache error"
	fi
	echo "$cache2"
}

cache1_to_cache2()
{
	local cache1=${1:-$(</dev/stdin)}
	if [[ $cache_type == 2 ]] && IS_CACHE1 "$cache1" ||
	   [[ "$cache1" =~ .recipe$ ]]; then
		sha1=($(sha1sum <<<"$cache1"))
		cache1=${CACHE_DIR/#\~/$HOME}/images/$sha1
	fi
	echo "$cache1"
}

commit_to_cache2()
{
	echo "$1" >  "$CACHE_DIR/refs/${2##*/}" ||
		report_error 8 "Can't write to cache"
}

skip_command()
{
	local current=$( get_current_wallpaper_filename | cache2_to_cache1 )
	local dir file recipe="" wallpaper

	dir="${current%/*}" ; file="${current##*/}"

	if IS_CACHE1 "$current"; then
		dir="${dir%/\.wall-cache}"
		recipe="${file##*__}"
		file="${file%__*}"
	fi

	wallpaper=$(images_from_directory "$dir" | (
			case $1 in
			   (next) sed -n "/$file/{n;p}" ;;
			   (prev) sed -n "/$file/{x;p;d;}; x" ;;
			esac ) )

	if [[ "$wallpaper" == "" ]]; then
		case $1 in
		   (next) wallpaper=$( first_file_from_dir "$dir" ) ;;
	           (prev) wallpaper=$( last_file_from_dir "$dir" ) ;;
		esac
	fi

	set_command "$dir/$wallpaper"
}

blur()
{
	debug_log convert "$1" -resize 50% -blur 0x${3:-5} -resize 200% "png:$2"
	convert "$1" -resize 50% -blur 0x${3:-5} -resize 200% "png:$2"
}

dim()
{
	debug_log convert "$1" -fill black -colorize ${3:-40}% "png:$2"
	convert "$1" -fill black -colorize ${3:-40}% "png:$2"
}

tint()
{
	IFS=':' read -r -a params <<< "$3"
	debug_log convert "$1" -fill "'rgb(${params[0]},${params[1]},${params[2]})'" \
		-colorize ${params[3]:-40}% "png:$2"
	convert "$1" -fill "rgb(${params[0]},${params[1]},${params[2]})" \
		-colorize ${params[3]:-40}% "png:$2"
}

ensure_cache_exists()
{
	case $cache_type in

		1)	if [[ ! -d "${1%/*}/.wall-cache" ]]; then
				mkdir "${1%/*}/.wall-cache" ||
					report_error 6 "Couldn't create cache in ${1%/*}"
			fi ;;

		2)	if [[ ! -d "${CACHE_DIR}/images" ]] ||
			   [[ ! -d "${CACHE_DIR}/refs" ]]; then
				mkdir -p "${CACHE_DIR}/images"
				mkdir -p "${CACHE_DIR}/refs"
			fi ;;
	esac
}

recipe_to_cachename() {
	local filename filter

	if [[ $1 == 0 ]]; then
		filename=$2
	else
		if IS_CACHE1 "$2"; then
			filename=$2+
		else
			filename=${2%/*}/.wall-cache/${2##*/}__
		fi

		filename+=${the_recipe[0]}
		for filter in "${the_recipe[@]:1:$(($1-1))}"; do
			filename+="+$filter"
		done
	fi

	echo $filename
}

apply_filter()
{
	local to=$(cache1_to_cache2 "$3")
	${the_recipe[$1]%%:*} "$2" "$to" "$(extract_arg ${the_recipe[$1]})" || exit $?
	commit_to_cache2 "$3" "$to"
	echo "$to"
}

generate_image_from()
{
	ensure_cache_exists "$2"
	from=$(recipe_to_cachename $1 "$2" | cache1_to_cache2)
	for ((i=$1;i<${#the_recipe[@]};i++)); do
		to=$(recipe_to_cachename $(($i+1)) "$2")
		from=$(apply_filter $i "$from" "$to") || exit $?
	done
}

ensure_image_is_cached()
{
	for ((i=${#the_recipe[@]};i>=0;i--)); do
		partial_result=$(recipe_to_cachename $i "$1" | cache1_to_cache2)
		if [[ -e "$partial_result" ]] &&
		   [[ ! "$partial_result" -ot "$1" ]]; then
			generate_image_from $i "$1"
			return 0
		fi
	done
	report_error 4 "Missing $partial_result."
}

ensure_recipe_is_cached()
{
	local file recipe_string recipe=()

	[[ $(head "$1" -c 3) == set ]] ||
		report_error 11 "Invalid recipe $1."

	recipe_string=$(head "$1" -n 1) ||
		report_error 9 "Can't read $1."

	while IFS= read -r ; do
		recipe+=( "$REPLY" )
	done < <(xargs printf '%s\n' <<<$recipe_string)

	produced_file="$( cd "$(dirname $1)" || exit
			  dry_run=yes set_command "${recipe[@]:1}"
			  echo "$produced_file" )" || exit

	file=$(cache1_to_cache2 "$1")
	cp "$(cache1_to_cache2 "$produced_file")" "$file"
	commit_to_cache2 "$1" "$file"
}

extract_num() {
	if [[ $1 =~ ^[0-9:]+$ ]]; then
		echo ":$1"
		return 0
	else
		echo ""
		return 1
	fi
}

get_recipe() {
	the_recipe=()
	while [[ $# -gt 0 ]]; do
		filter=$1
		case $filter in

			dim)	;&
			blur)	;&
			tint)
				argument=$(extract_num $2) && shift
				the_recipe+=("$filter$argument")
				shift
				;;
			*)
				report_error 2 "Invalid operation $filter"
				;;
		esac
	done
}

get_proposed_file() {
	local proposed_file=$1

	if [[ "${proposed_file^^}" == "CLIP" ]]; then
		proposed_file=$(xclip -o)
	fi
	if [[ "$proposed_file" == "default" ]]; then
		proposed_file="$DEFAULT_WALLPAPER"
	fi
	if [[ -d "$proposed_file" ]]; then
		proposed_file+="/$(first_file_from_dir "$proposed_file")"
	fi

	if [[ ! -e "$proposed_file" ]]; then
		report_error 1 "Image $proposed_file does not exists."
	else
		proposed_file=$(realpath -s "$proposed_file") || exit $?
		if [[ "$proposed_file" =~ \.recipe$ ]]; then
			ensure_recipe_is_cached "$proposed_file"
		fi
		echo "$(cache2_to_cache1 "$proposed_file")"
	fi
}

set_command()
{
	local wallpaper_file 

	wallpaper_file=$(get_proposed_file "$1") || exit $?
	shift ; get_recipe "$@"
	if (( ${#the_recipe[@]} > 0 )); then
		ensure_image_is_cached $wallpaper_file
		wallpaper_file=$(recipe_to_cachename ${#the_recipe[@]} \
						    "$wallpaper_file")
	fi
	produced_file=$wallpaper_file
	wallpaper_file=$(cache1_to_cache2 "$wallpaper_file")
	set_current_wallpaper "$wallpaper_file"
}

LS_FLAGS=""
dry_run=""
unset CDPATH

if [[ $1 = -x ]]; then
	shift
	set -x
fi

case "$1" in

	set)
		shift
		set_command "$@"
		;;
	dim)	;&
	blur)	;&
	tint)
		set_command "$(get_current_wallpaper_filename)" "$@"
		;;

	getfilename)
		echo $(get_current_wallpaper_filename)
		;;
	browse)
		echo "Browse wallpapers."
		;;
	next)
		skip_command next
		;;
	prev)
		skip_command prev
		;;
	*)
		echo "Invalid command." >&2
		usage
		;;
esac
